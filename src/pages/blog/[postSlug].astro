---
import { getCollection } from 'astro:content'
import Layout from '../../layouts/Layout.astro'

export async function getStaticPaths() {
  const posts = await getCollection('blog')
  return posts
    .filter((post) => import.meta.env.DEV || post.data.published !== false)
    .map((post) => ({
      params: { postSlug: post.slug },
    }))
}

const { postSlug } = Astro.params
const post = (await getCollection('blog')).find(
  (p) =>
    p.slug === postSlug && (import.meta.env.DEV || p.data.published !== false),
)
const authorData = (await getCollection('authors'))[0].data

if (!post) {
  return Astro.redirect('/404')
}

const author = authorData.find((a) => a.slug === post.data.author)
const authorRole = post.data.authorRole || author?.role

if (!author) {
  throw new Error(`Author not found for slug: ${post.data.author}`)
}

const { Content } = await post.render()

// Import banner if exists
let Banner = null
if (post.data.bannerEnd) {
  try {
    Banner = (await import(`../../banners/${post.data.bannerEnd}.astro`))
      .default
  } catch (error) {
    console.error('Banner loading error:', error)
  }
}

const contentBoxClass = 'py-responsive-md'
---

<Layout title={post.data.title}>
  <!-- HERO BOX (meta + title + excerpt) -->
  <section class="section-full">
    <div class="container-bordered">
      <div class="px-responsive py-responsive-lg">
        <div class="blog-hero mx-auto flex max-w-6xl flex-col">
          <div class="blog-hero__content">
            <div class="mb-10 flex items-center gap-x-4 pt-2 text-xl">
              <img
                class="h-10 w-10 rounded-full"
                src={author.avatar}
                alt={`Avatar of ${author.name}`}
              />
              <span class="text-white">
                <span class="font-semibold">{author.name}</span>
                <span class="ml-2 text-gray-400">{authorRole}</span>
              </span>
              <span class="text-gray-600">·</span>
              {
                post.data.category && (
                  <>
                    <a
                      href={`/category/${post.data.category}`}
                      class="text-gray-500 hover:text-gray-300"
                    >
                      {post.data.category}
                    </a>
                    <span class="text-gray-600">·</span>
                  </>
                )
              }
              <time datetime={post.data.date} class="text-gray-500">
                {
                  new Date(post.data.date).toLocaleDateString('pl-PL', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                  })
                }
              </time>
            </div>

            <h1
              class="mb-10 text-6xl font-light leading-tight text-white md:text-7xl"
            >
              {post.data.title}
            </h1>

            {
              post.data.excerpt && (
                <p class="mb-0 text-3xl font-light leading-relaxed text-gray-300 md:text-4xl">
                  {post.data.excerpt}
                </p>
              )
            }
          </div>

          <a
            href="#post-content"
            class="blog-hero__scroll-indicator"
            aria-label="Scroll to article content"
          >
            <span class="blog-hero__chevron" aria-hidden="true">
              <span class="blog-hero__chevron-left"></span>
              <span class="blog-hero__chevron-right"></span>
            </span>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- CONTENT BOX (article + banner) -->
  <section class={`section-full ${Banner ? 'has-banner' : ''}`}>
    <div class="container-padded">
      <div class={contentBoxClass}>
        <article
          id="post-content"
          class="custom-markdown prose-blog prose mx-auto max-w-5xl text-white"
          style="scroll-margin-top: calc(var(--header-spacer-height) + 24px);"
        >
          <Content />
        </article>
      </div>

      {
        Banner && (
          <div class="blog-banner-wrapper">
            <Banner />
          </div>
        )
      }
    </div>
  </section>
</Layout>

<script is:inline>
  // Smooth-scroll to article content for the hero indicator
  document.addEventListener('DOMContentLoaded', () => {
    const trigger = document.querySelector('.blog-hero__scroll-indicator')
    const target = document.getElementById('post-content')
    if (!trigger || !target) return

    trigger.addEventListener('click', (e) => {
      e.preventDefault()
      target.scrollIntoView({ behavior: 'smooth', block: 'start' })
    })
  })
</script>

<style lang="scss">
  /* Hero section: full viewport height minus header */
  .section-full:first-of-type {
    /* Use max-height to prevent section from exceeding viewport */
    max-height: calc(100dvh - var(--header-spacer-height, 0px));
    max-height: calc(100svh - var(--header-spacer-height, 0px));
    max-height: calc(100vh - var(--header-spacer-height, 0px));
    min-height: calc(100dvh - var(--header-spacer-height, 0px));
    min-height: calc(100svh - var(--header-spacer-height, 0px));
    min-height: calc(100vh - var(--header-spacer-height, 0px));
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .section-full:first-of-type > .container-bordered {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0; /* Allow flexbox to shrink */
  }

  .section-full:first-of-type > .container-bordered > div {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0; /* Allow flexbox to shrink */
  }

  .blog-hero {
    position: relative;
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0; /* Allow flexbox to shrink */
  }

  .blog-hero__content {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .blog-hero__scroll-indicator {
    display: block;
    width: min(200px, 50vw);
    height: 18px;
    margin: 2.5rem auto 0;
    padding: 1rem 0 0.25rem;
    opacity: 0.55;
    transition:
      opacity 450ms ease-in-out,
      transform 450ms ease-in-out;
    animation: blogHeroBreathe 1800ms ease-in-out infinite;
  }

  .blog-hero__scroll-indicator:hover {
    opacity: 1;
    animation: none;
    transform: translateY(2px);
  }

  .blog-hero__chevron {
    display: grid;
    grid-template-columns: 1fr 1fr;
    align-items: center;
    gap: 0;
    width: 100%;
    height: 100%;
  }

  .blog-hero__chevron-left,
  .blog-hero__chevron-right {
    height: 0;
    /* Use border-top for sharper rendering on thin lines */
    border-top: 1px solid rgba(255, 255, 255, 0.5);
    transition:
      border-top-color 450ms ease-in-out,
      transform 450ms ease-in-out;
    transform: translateZ(0);
    will-change: transform;
    /* Improve rendering sharpness */
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  .blog-hero__chevron-left {
    transform-origin: right center;
    transform: translateZ(0) rotate(4deg);
  }

  .blog-hero__chevron-right {
    transform-origin: left center;
    transform: translateZ(0) rotate(-4deg);
  }

  .blog-hero__scroll-indicator:hover .blog-hero__chevron-left,
  .blog-hero__scroll-indicator:hover .blog-hero__chevron-right {
    border-top-color: rgba(255, 255, 255, 0.95);
  }

  .blog-hero__scroll-indicator:hover .blog-hero__chevron-left {
    transform: translateZ(0) rotate(35deg);
  }

  .blog-hero__scroll-indicator:hover .blog-hero__chevron-right {
    transform: translateZ(0) rotate(-35deg);
  }

  .blog-hero__scroll-indicator:focus-visible {
    outline: 2px solid rgba(255, 255, 255, 0.7);
    outline-offset: 6px;
    border-radius: 9999px;
    opacity: 1;
    animation: none;
  }

  @keyframes blogHeroBreathe {
    0%,
    100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(6px);
    }
  }

  /* Remove padding-bottom from container-padded when banner is present */
  .section-full.has-banner > .container-padded {
    padding-bottom: 0;
  }

  /* Banner wrapper: equal top spacing to match article top padding (py-responsive-md) */
  .blog-banner-wrapper {
    margin-top: 4rem; /* 64px desktop - matches py-responsive-md padding-top */
    @media (max-width: 1440px) {
      margin-top: 3rem; /* 48px large */
    }
    @media (max-width: 1000px) {
      margin-top: 2rem; /* 32px medium */
    }
    @media (max-width: 770px) {
      margin-top: 1.5rem; /* 24px tablet */
    }
    @media (max-width: 480px) {
      margin-top: 1rem; /* 16px mobile */
    }
  }
</style>
